<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜Ÿéš›é‡é›£è€…ï¼šç²‰ç´…ç”Ÿå­˜æˆ°</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // å®šç¾©ä¸€çµ„æš—ç²‰è‰²ç³»ï¼Œé©åˆç§‘å¹»ç”Ÿå­˜åˆä¸åˆºçœ¼
                        rose: {
                            50: '#fff1f2',
                            100: '#ffe4e6',
                            200: '#fecdd3',
                            300: '#fda4af',
                            400: '#fb7185',
                            500: '#f43f5e',
                            600: '#e11d48',
                            700: '#be123c',
                            800: '#9f1239',
                            900: '#881337',
                            950: '#4c0519', // æ·±è‰²èƒŒæ™¯ç”¨
                        },
                        // å¤–æ˜Ÿé™£ç‡Ÿè‰² (ç²‰ç´«)
                        alien: {
                            DEFAULT: '#d946ef', // fuchsia-500
                            dark: '#701a75',    // fuchsia-900
                            glow: '#f0abfc'     // fuchsia-300
                        },
                        // åœ°çƒé™£ç‡Ÿè‰² (é’è—)
                        earth: {
                            DEFAULT: '#0ea5e9', // sky-500
                            dark: '#0c4a6e',    // sky-900
                            glow: '#7dd3fc'     // sky-300
                        }
                    }
                }
            }
        }
    </script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- 1. éŠæˆ²è¨­å®šè³‡æ–™ ---
        const ROLES = {
            1: "æ¼¢å¾·æ£®", 2: "è³ˆæ–¯å¹½", 3: "æ ¼æ‹‰å…‹", 4: "æˆˆå¾·å‡",
            5: "æ€ç‘ªç‰¹", 6: "å‰å°¼äº", 7: "è‰¾è‰æ ¹", 8: "æ‹‰å¼—ç±³",
            9: "ç®¡ç†å“¡"
        };

        const FOOD_DATA = {
            101: { name: "è±ªå¤§å¤§é›æ’", score: 80, desc: "å·¨å¤§çš„æ‰å¹³ç”Ÿç‰©çµ„ç¹”ï¼Œè˜Šå«æ¥µé«˜æ²¹è„‚å‹•èƒ½ã€‚" },
            102: { name: "å¤§è…¸åŒ…å°è…¸", score: 50, desc: "è…¸é“åŒ…è£¹è‘—ç¢³æ°´åŒ–åˆç‰©ï¼Œçµæ§‹ç²¾å·§çš„èƒ½é‡æ£’ã€‚" },
            103: { name: "çç å¥¶èŒ¶", score: 80, desc: "å¯Œå«é«˜å¯†åº¦æ¾±ç²‰çƒé«”ï¼Œæ¶²æ…‹ç³–åˆ†æ¥µæ˜“å¸æ”¶ã€‚" },
            104: { name: "èšµä»”ç…", score: 50, desc: "æµ·æ´‹è»Ÿé«”å‹•ç‰©èˆ‡æ¾±ç²‰çš„æ··åˆé»æ¶²ï¼Œå£æ„Ÿç¥ç¥•ã€‚" },
            105: { name: "èŠ’æœé›ªèŠ±å†°", score: 80, desc: "ä½æº«çµæ™¶é«”ä½ä»¥é»ƒè‰²æœå¯¦ï¼Œèƒ½å†·å»åæ‡‰çˆã€‚" },
            106: { name: "æ·±å‘è‡­è±†è…", score: 50, desc: "æ•£ç™¼å¼·çƒˆç”ŸåŒ–æ°£å‘³ï¼Œç–‘ä¼¼é«˜æ¿ƒåº¦ç¡«åŒ–ç‡ƒæ–™ã€‚" },
            107: { name: "è—¥ç‡‰æ’éª¨", score: 80, desc: "é»‘è‰²æ¶²é«”ä¸­æµ¸æ³¡è‘—è„Šæ¤éª¨ï¼Œå……æ»¿æœªçŸ¥çš„è‰æœ¬èƒ½é‡ã€‚" },
            108: { name: "åœ°ç“œçƒ", score: 50, desc: "ä¸­ç©ºçš„æ²¹ç‚¸çƒé«”ï¼Œé›–ç„¶ç©ºæ°£å¾ˆå¤šä½†å¤–æ®¼é…¥è„†ã€‚" },
            201: { name: "ç³–è‘«è˜†", score: 10, desc: "ç´…è‰²çƒé«”è¢«ç¡¬åŒ–ç³–è¡£åŒ…è£¹ï¼Œèƒ½é‡å¯†åº¦æ¥µä½ã€‚" },
            202: { name: "ç«ç„°ç‚™ç‡’ç‰›æ’", score: 110, desc: "é«˜æº«è™•ç†çš„è›‹ç™½è³ªå¡Šï¼Œå¯Œå«ç´…è¡€ç´ èˆ‡ç†±èƒ½ã€‚" },
            203: { name: "è±¬è¡€ç³•", score: 10, desc: "é»‘è‰²æ–¹å¡Šæ··åˆäº†ç”Ÿç‰©æ¶²é«”èˆ‡ç©€ç‰©ï¼Œèƒ½é‡åæ‡‰å¾®å¼±ã€‚" },
            204: { name: "æ½¤é¤…æ²", score: 60, desc: "è–„çš®åŒ…è£¹å¤§é‡æ¤ç‰©çº–ç¶­ï¼Œåƒ…èƒ½ç¶­æŒåŸºæœ¬é‹ä½œã€‚" },
            205: { name: "æ»·å‘³è±†å¹²", score: 10, desc: "è„«æ°´çš„è±†é¡æ–¹å¡Šï¼Œä¹¾ç‡¥ä¸”ç„¡å‘³ï¼Œä¸å…·é–‹æ¡åƒ¹å€¼ã€‚" },
            206: { name: "çˆ†æ¼¿éª°å­ç‰›", score: 110, desc: "åˆ‡å‰²å·¥æ•´çš„ç«‹æ–¹é«”è‚‰å¡Šï¼Œå…§éƒ¨å°å­˜äº†æ»¾ç‡™æ²¹è„‚ã€‚" },
            207: { name: "ç‡’ä»™è‰", score: 10, desc: "é»‘è‰²å‡è† ç‹€æ¶²é«”ï¼Œå†·å»å¾Œæœƒå›ºåŒ–ï¼Œèƒ½é‡ä¸ç©©å®šã€‚" },
            208: { name: "èƒ¡æ¤’é¤…", score: 60, desc: "è²¼å£é«˜æº«çƒ˜çƒ¤ï¼Œå«æœ‰å°‘é‡è‚‰æœ«èˆ‡è¾›é¦™æ–™ã€‚" },
            301: { name: "é¼æ³°è±å°ç± åŒ…", score: 90, desc: "é»ƒé‡‘æ¯”ä¾‹çš„æ‘ºæ•¸ï¼Œå°å°äº†é«˜æ¿ƒç¸®æ¹¯æ±ç²¾è¯ã€‚" },
            302: { name: "å† è»ç‰›è‚‰éºµ", score: 90, desc: "è¤‡åˆå¼æ¹¯é ­èˆ‡å¤§å¡Šè‚Œç†çµ„ç¹”ï¼Œå®Œç¾çš„èƒ½æºè£œçµ¦ã€‚" },
            303: { name: "çƒ¤é¦™è…¸", score: 20, desc: "äºç¡é…¸é¹½èˆ‡è„‚è‚ªçš„ç®¡ç‹€æ··åˆç‰©ï¼Œåƒ…ä¾›å¨›æ¨‚ã€‚" },
            304: { name: "ä½›è·³ç‰†", score: 90, desc: "å°‡å¤šç¨®é«˜éšç”Ÿç‰©çµ„ç¹”ç‡‰ç…®æ–¼ä¸€ç½ˆï¼Œèƒ½é‡çˆ†è¡¨ã€‚" },
            305: { name: "æª¸æª¬æ„›ç‰", score: 20, desc: "99% éƒ½æ˜¯æ°´åˆ†èˆ‡æ¤ç‰©è† è³ªï¼Œå¹¾ä¹æ²’æœ‰ç†±é‡ã€‚" },
            306: { name: "ç‚¸èŠ‹é¤…", score: 20, desc: "æ²¹ç‚¸çš„æ ¹è–é¡æ¤ç‰©ï¼Œçµæ§‹é¬†æ•£ï¼Œèƒ½é‡ä½è½ã€‚" },
            307: { name: "ç‡Ÿé¤Šä¸‰æ˜æ²»", score: 20, desc: "æ²¹ç‚¸éºµåŒ…å¤¾ç¾ä¹ƒæ»‹ï¼Œç†±é‡é›–é«˜ä½†ç¼ºä¹æ ¸å¿ƒç‰©è³ªã€‚" },
            308: { name: "ç´…èŸ³ç±³ç³•", score: 90, desc: "ç”²æ®¼é¡ç”Ÿç‰©è¦†è“‹æ–¼ç³¯ç±³ä¹‹ä¸Šï¼Œå¯Œå«ç¨€æœ‰è›‹ç™½è³ªã€‚" },
        };

        const GAME_SCRIPT = {
            1: [101, 102, 103, 104, 105, 106, 107, 108],
            2: [201, 202, 203, 204, 205, 206, 207, 208],
            3: [301, 302, 303, 304, 305, 306, 307, 308]
        };

        const firebaseConfig = {
            apiKey: "AIzaSyA3Ecj9bNgARAhzrq6_BD4AeiegAku3wak",
            authDomain: "lineweb-24cc1.firebaseapp.com",
            databaseURL: "https://lineweb-24cc1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lineweb-24cc1",
            storageBucket: "lineweb-24cc1.firebasestorage.app",
            messagingSenderId: "97364985402",
            appId: "1:97364985402:web:e3f124780c76f522bd1703"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const ROOM_ID = "room_1";

        let myRole = null;
        let myName = "";
        let globalState = { phase: 'waiting', round: 1 };
        let allPlayers = {};
        let roundResult = {};
        let myData = {};
        let localSeenRound = 0;

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        async function init() {
            let roleParam = getQueryParam("role") || "1";
            if (!ROLES[roleParam]) {
                document.getElementById('app-inner').innerHTML = `<div class="p-10 text-center text-white">ç„¡æ•ˆçš„é€£çµåƒæ•¸ (Role Error)</div>`;
                return;
            }

            myRole = parseInt(roleParam);
            myName = ROLES[myRole];
            console.log(`[Identity] ${myName} (Role ${myRole})`);

            if (myRole !== 9) {
                showView('waiting-view');
                document.getElementById('waiting-name').innerText = myName;
            } else {
                showView('admin-view');
            }

            onValue(ref(db, `${ROOM_ID}/game_state`), (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    globalState = val;
                    handleGameStateChange();
                } else if (myRole === 9) {
                    renderAdminPanel();
                }
            });

            onValue(ref(db, `${ROOM_ID}/players`), (snapshot) => {
                allPlayers = snapshot.val() || {};
                if (myRole !== 9) {
                    myData = allPlayers[myRole] || {};
                    if (globalState.phase === 'action') {
                        renderRealtimeStats(); 
                        renderActionView();
                    }
                } else {
                    renderAdminPanel();
                }
            });

            onValue(ref(db, `${ROOM_ID}/round_result`), (snapshot) => {
                roundResult = snapshot.val() || {};
                if (globalState.phase === 'result') renderResultView();
            });

            // ç©å®¶è‡ªæˆ‘è¨»å†Š (é˜²å‘†ç”¨ï¼Œä¸»è¦é‚„æ˜¯é  Admin åˆå§‹åŒ–)
            if (myRole !== 9) {
                const myRef = ref(db, `${ROOM_ID}/players/${myRole}`);
                const snap = await get(myRef);
                if (!snap.exists()) {
                    await update(myRef, {
                        name: myName, lives: 2, is_dead: false,
                        food_target: "A", group_target: "A", current_energy: 0
                    });
                }
            }
        }

        function showView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(viewId);
            if (target) target.classList.remove('hidden');
        }

        function handleGameStateChange() {
            const { phase, round } = globalState;
            
            if (myRole === 9) {
                showView('admin-view');
                renderAdminPanel();
            } else {
                if (phase === 'waiting') {
                    showView('waiting-view');
                }
                else if (phase === 'action') {
                    if (round > localSeenRound) {
                        showView('draw-view');
                        renderDrawCard(round);
                    } else {
                        // ç§»é™¤ initActionView çš„å‘¼å«ï¼Œå› ç‚ºç¾åœ¨å…¨éƒ¨ç”± Admin å¯«å…¥
                        showView('action-view');
                        renderActionView();
                    }
                }
                else if (phase === 'result') {
                    showView('result-view');
                }
                else if (phase === 'end') {
                    showView('end-view');
                }
            }
        }

        function renderDrawCard(round) {
            const cardId = GAME_SCRIPT[round][myRole - 1];
            const card = FOOD_DATA[cardId];
            
            document.getElementById('draw-card-container').innerHTML = `
                <div class="animate-bounce mb-6 text-7xl drop-shadow-[0_0_15px_rgba(244,114,182,0.6)]">ğŸ</div>
                <div class="bg-gray-800/90 p-6 rounded-3xl border-2 border-rose-500 shadow-xl max-w-xs mx-auto backdrop-blur-md">
                    <h2 class="text-2xl font-black text-rose-400 mb-2 tracking-wider">${card.name}</h2>
                    <div class="text-gray-300 text-sm mb-4 font-bold bg-gray-700/50 py-2 px-3 rounded-lg">${card.desc}</div>
                    <div class="text-5xl font-black text-white neon-text-pink">èƒ½é‡ ${card.score}</div>
                </div>
            `;
        }

        window.confirmDraw = function() {
            localSeenRound = globalState.round;
            handleGameStateChange();
        }

        function renderActionView() {
            if (myRole === 9 || !myData.name) return;
            const round = globalState.round || 1;
            const cardId = GAME_SCRIPT[round][myRole - 1];
            const card = FOOD_DATA[cardId];
            
            document.getElementById('round-num').innerText = round;

            document.getElementById('my-food-display').innerHTML = `
                <div class="text-center">
                    <div class="text-rose-300 text-xs font-bold mb-1 bg-rose-900/50 inline-block px-3 py-1 rounded-full border border-rose-800">æ‚¨ç²å¾—çš„ç‰©è³‡</div>
                    <div class="text-2xl font-black text-white mt-2">${card.name} <span class="text-xl text-rose-400">(${card.score})</span></div>
                </div>
            `;

            document.getElementById('my-lives-display').innerHTML = `
                <div class="flex items-center gap-2 bg-gray-900/60 px-4 py-2 rounded-full border border-rose-900">
                    <span class="text-rose-400 font-bold text-sm">ç”Ÿå‘½</span>
                    <div class="flex gap-1 text-rose-500 drop-shadow-sm text-xl">
                        ${renderHearts(myData.lives)}
                    </div>
                </div>
            `;
            
            if (myData.is_dead) document.getElementById('ghost-alert').classList.remove('hidden');
            else document.getElementById('ghost-alert').classList.add('hidden');
            
            updateToggleButton('food', myData.food_target);
            updateToggleButton('group', myData.group_target);
        }

        function renderHearts(count) {
            let h = '';
            for(let i=0; i<2; i++) h += `<i class="fa-${i < count ? 'solid' : 'regular'} fa-heart ${i >= count ? 'opacity-30' : ''} transform"></i>`;
            return h;
        }

        function renderRealtimeStats() {
            let ea = 0, eb = 0;
            Object.values(allPlayers).forEach(p => {
                const s = p.is_dead ? 0 : (p.current_energy || 0);
                if (p.food_target === "A") ea += s; else eb += s;
            });
            document.getElementById('stat-energy-a').innerText = ea;
            document.getElementById('stat-energy-b').innerText = eb;
        }

        window.toggleChoice = function(type, val) {
            if (globalState.is_locked) return;
            const obj = {}; obj[type === 'food' ? 'food_target' : 'group_target'] = val;
            update(ref(db, `${ROOM_ID}/players/${myRole}`), obj);
            if (navigator.vibrate) navigator.vibrate(30);
        }

        function updateToggleButton(type, val) {
            const a = document.getElementById(`btn-${type}-a`), b = document.getElementById(`btn-${type}-b`);
            if (!a || !b) return;
            
            // å¼·çƒˆçš„é¸ä¸­ç‹€æ…‹ (é«˜äº®ã€å¯¦å¿ƒã€é‚Šæ¡†)
            const activeClassA = 'bg-alien text-white border-alien-glow shadow-[0_0_15px_rgba(217,70,239,0.5)] ring-2 ring-alien-glow scale-105 opacity-100 z-10';
            const activeClassB = 'bg-earth text-white border-earth-glow shadow-[0_0_15px_rgba(14,165,233,0.5)] ring-2 ring-earth-glow scale-105 opacity-100 z-10';
            
            // æœªé¸ä¸­ç‹€æ…‹ (æš—æ·¡ã€é€æ˜ã€ç¸®å°)
            const inactiveClass = 'bg-gray-800/50 text-gray-500 border-gray-700 opacity-50 scale-95 hover:opacity-80';

            // Reset base classes
            const baseClass = "w-full rounded-2xl font-bold transition-all duration-300 border-2 flex flex-col items-center justify-center gap-1 relative";

            if (type === 'food') {
                a.className = `${baseClass} py-4 ${val === 'A' ? activeClassA : inactiveClass}`;
                b.className = `${baseClass} py-4 ${val === 'B' ? activeClassB : inactiveClass}`;
            } else {
                a.className = `${baseClass} py-6 ${val === 'A' ? activeClassA : inactiveClass}`;
                b.className = `${baseClass} py-6 ${val === 'B' ? activeClassB : inactiveClass}`;
            }
        }

        function renderResultView() {
            if (!roundResult.avg_A) return;
            const myAvg = myData.group_target === 'A' ? roundResult.avg_A : roundResult.avg_B;
            const isSafe = myAvg >= 60;
            
            document.getElementById('result-content').innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-800/80 p-3 rounded-2xl border border-alien shadow-lg">
                        <div class="text-xs text-alien-glow font-bold mb-1">å¤–æ˜Ÿäººèƒ½é‡</div>
                        <div class="text-3xl font-black text-alien">${roundResult.energy_A}</div>
                    </div>
                    <div class="bg-gray-800/80 p-3 rounded-2xl border border-earth shadow-lg">
                        <div class="text-xs text-earth-glow font-bold mb-1">åœ°çƒäººèƒ½é‡</div>
                        <div class="text-3xl font-black text-earth">${roundResult.energy_B}</div>
                    </div>
                </div>
                <div class="bg-gray-900/80 p-4 rounded-2xl mb-6 shadow-md border border-gray-700 flex justify-around">
                    <div class="${roundResult.avg_A >= 60 ? 'text-green-400 font-bold' : 'text-red-400 font-bold'}">
                        å¤–æ˜Ÿå‡åˆ†: ${Math.floor(roundResult.avg_A)}
                    </div>
                    <div class="w-px bg-gray-600"></div>
                    <div class="${roundResult.avg_B >= 60 ? 'text-green-400 font-bold' : 'text-red-400 font-bold'}">
                        åœ°çƒå‡åˆ†: ${Math.floor(roundResult.avg_B)}
                    </div>
                </div>
                <div class="text-center py-8 border-4 border-dashed ${isSafe ? 'border-green-500/50 bg-green-900/20' : 'border-red-500/50 bg-red-900/20'} rounded-3xl">
                     <i class="fa-solid ${isSafe ? 'fa-shield-heart text-green-400' : 'fa-heart-crack text-red-500'} text-7xl mb-4 drop-shadow-lg"></i>
                     <h2 class="text-3xl font-black text-white">${isSafe ? 'ç”Ÿå­˜ç¢ºèª' : 'å—åˆ°å‚·å®³'}</h2>
                     <p class="text-sm mt-2 ${isSafe ? 'text-green-300' : 'text-red-300'}">${isSafe ? 'èƒ½é‡è£œçµ¦å……è¶³' : 'èƒ½é‡ä¸è¶³ï¼Œç”Ÿå‘½å€¼ä¸‹é™'}</p>
                </div>
            `;
        }

        function renderAdminPanel() {
            const ctrl = document.getElementById('admin-controls');
            if (!globalState.phase) {
                ctrl.innerHTML = `<button onclick="resetGame()" class="w-full bg-red-600 py-4 rounded font-bold text-white shadow">åˆå§‹åŒ–è³‡æ–™åº«</button>`;
                return;
            }
            document.getElementById('admin-status').innerHTML = `Round: ${globalState.round} | Phase: ${globalState.phase}`;
            let btns = '';
            const p = globalState.phase;
            
            // ä¸»æŒäººæŒ‰éˆ•ï¼šé–‹å§‹å›åˆæ™‚ï¼Œæœƒè‡ªå‹•å¹«æ‰€æœ‰äººåˆ†é…éš¨æ©Ÿé¸é …
            if (p === 'waiting') btns = `<button onclick="adminStartRound(1)" class="w-full bg-rose-600 hover:bg-rose-500 text-white py-4 rounded-xl font-bold shadow-lg transition transform hover:scale-105">ğŸš€ é–‹å•Ÿç¬¬ä¸€å¤© (è‡ªå‹•ä½ˆå±€)</button>`;
            else if (p === 'action') btns = `<button onclick="adminCalculate()" class="w-full bg-gray-600 hover:bg-gray-500 text-white py-4 rounded-xl font-bold shadow-lg transition transform hover:scale-105">ğŸ”’ é–å®šä¸¦çµç®—</button>`;
            else if (p === 'result') btns = `<button onclick="${globalState.round < 3 ? `adminStartRound(${globalState.round + 1})` : "adminSetPhase('end')"}" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white py-4 rounded-xl font-bold shadow-lg transition transform hover:scale-105">${globalState.round < 3 ? 'ğŸŒ… é€²å…¥ä¸‹ä¸€å¤© (è‡ªå‹•ä½ˆå±€)' : 'ğŸ çµæŸéŠæˆ²'}</button>`;
            else btns = `<button onclick="resetGame()" class="w-full border-2 border-red-400 text-red-500 py-2 rounded-xl">é‡ç½®éŠæˆ²</button>`;
            ctrl.innerHTML = btns;

            let stats = { A_pop: 0, B_pop: 0, A_eng: 0, B_eng: 0 };
            let playersHtml = `<div class="mt-4 space-y-2">`;
            Object.keys(ROLES).forEach(id => {
                if (id == 9) return;
                const player = allPlayers[id] || { name: ROLES[id], lives: 2, is_dead: false };
                
                if (!player.is_dead) {
                    if (player.group_target === 'A') stats.A_pop++; else stats.B_pop++;
                    const score = player.current_energy || 0;
                    if (player.food_target === 'A') stats.A_eng += score; else stats.B_eng += score;
                }

                playersHtml += `<div class="flex justify-between items-center text-xs p-2 bg-gray-800 rounded border border-gray-700 ${player.is_dead ? 'opacity-50 line-through' : ''}">
                    <span class="text-gray-300">${player.name} <span class="text-rose-400">(${player.lives}â¤)</span> <span class="text-gray-500">[${player.current_energy}]</span></span>
                    <div class="flex gap-2">
                        <span class="px-2 py-0.5 rounded ${player.food_target==='A'?'bg-alien text-white':'bg-earth text-white'}">é£Ÿ:${player.food_target}</span>
                        <span class="px-2 py-0.5 rounded ${player.group_target==='A'?'bg-alien text-white':'bg-earth text-white'}">äºº:${player.group_target}</span>
                    </div>
                </div>`;
            });
            document.getElementById('admin-players').innerHTML = playersHtml + `</div>`;

            document.getElementById('admin-summary').innerHTML = `
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="bg-alien-dark p-2 rounded text-center border border-alien">
                        <div class="text-alien-glow text-xs">å¤–æ˜Ÿäºº (A)</div>
                        <div class="text-white font-bold text-lg">${stats.A_eng} èƒ½ / ${stats.A_pop} äºº</div>
                    </div>
                    <div class="bg-earth-dark p-2 rounded text-center border border-earth">
                        <div class="text-earth-glow text-xs">åœ°çƒäºº (B)</div>
                        <div class="text-white font-bold text-lg">${stats.B_eng} èƒ½ / ${stats.B_pop} äºº</div>
                    </div>
                </div>
            `;
        }

        // é—œéµä¿®æ”¹ï¼šAdmin åœ¨é–‹å§‹å›åˆæ™‚ï¼Œç›´æ¥å¯«å…¥æ‰€æœ‰äººçš„éš¨æ©Ÿé¸é …
        window.adminStartRound = async (round) => {
            const updates = {};
            updates[`${ROOM_ID}/game_state/phase`] = 'action';
            updates[`${ROOM_ID}/game_state/round`] = round;
            updates[`${ROOM_ID}/game_state/is_locked`] = false;
            
            for (let i = 1; i <= 8; i++) {
                const cardId = GAME_SCRIPT[round][i-1];
                const card = FOOD_DATA[cardId];
                
                // 1. ç™¼ç‰Œ
                updates[`${ROOM_ID}/players/${i}/current_energy`] = card.score;
                updates[`${ROOM_ID}/players/${i}/current_card_name`] = card.name;
                
                // 2. è‡ªå‹•åˆ†é…éš¨æ©Ÿé¸é … (é€™æ¨£ Admin ä¸€å€‹äººä¹Ÿèƒ½æ¸¬è©¦)
                const randFood = Math.random() < 0.5 ? "A" : "B";
                const randGroup = Math.random() < 0.5 ? "A" : "B";
                updates[`${ROOM_ID}/players/${i}/food_target`] = randFood;
                updates[`${ROOM_ID}/players/${i}/group_target`] = randGroup;
            }
            
            updates[`${ROOM_ID}/round_result`] = {};
            await update(ref(db), updates);
        };

        window.adminSetPhase = (p) => update(ref(db, `${ROOM_ID}/game_state`), { phase: p, is_locked: false });
        
        window.adminCalculate = async () => {
            await update(ref(db, `${ROOM_ID}/game_state`), { is_locked: true });
            const snap = await get(ref(db, `${ROOM_ID}/players`));
            const players = snap.val();
            let sa = 0, pa = 0, sb = 0, pb = 0;
            Object.entries(players).forEach(([id, p]) => {
                const score = p.is_dead ? 0 : (p.current_energy || 0);
                if (p.food_target === 'A') sa += score; else sb += score;
                if (!p.is_dead) {
                    if (p.group_target === 'A') pa++; else pb++;
                }
            });
            const aa = pa > 0 ? sa/pa : 0, ab = pb > 0 ? sb/pb : 0;
            let up = {};
            Object.entries(players).forEach(([id, p]) => {
                if (p.is_dead) return;
                const avg = p.group_target === 'A' ? aa : ab;
                if (avg < 60) {
                    const l = p.lives - 1;
                    up[`${ROOM_ID}/players/${id}/lives`] = l;
                    if (l <= 0) up[`${ROOM_ID}/players/${id}/is_dead`] = true;
                }
            });
            up[`${ROOM_ID}/round_result`] = { energy_A: sa, energy_B: sb, avg_A: aa, avg_B: ab };
            up[`${ROOM_ID}/game_state/phase`] = 'result';
            await update(ref(db), up);
        };
        
        window.resetGame = async () => {
            await set(ref(db, ROOM_ID), { game_state: { phase: 'waiting', round: 1, is_locked: false }, players: {}, round_result: {} });
            window.location.reload();
        };

        init();
    </script>
    <style>
        /* å­—é«”è¨­å®š */
        body { font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif; }
        
        /* éœ“è™¹ç‰¹æ•ˆ */
        .neon-text-pink { text-shadow: 0 0 5px #f43f5e, 0 0 10px #f43f5e; }
        
        /* èƒŒæ™¯å‹•ç•« */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .float-anim { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body class="bg-rose-950 min-h-screen flex items-center justify-center p-4">

    <!-- ä¸»å®¹å™¨ï¼šæ·±è‰²ç»ç’ƒè³ªæ„Ÿï¼Œè­·çœ¼ä¸”ç§‘å¹» -->
    <div id="app" class="w-full max-w-md h-[92vh] bg-rose-900/40 backdrop-blur-xl border border-rose-500/30 shadow-[0_0_50px_rgba(244,63,94,0.2)] relative overflow-hidden rounded-[30px]">
        <div id="app-inner" class="p-6 h-full flex flex-col">
            
            <!-- === ç­‰å¾…ç•«é¢ === -->
            <div id="waiting-view" class="view-section hidden h-full flex flex-col justify-center items-center text-center">
                <div class="mb-8 float-anim">
                    <i class="fa-solid fa-shuttle-space text-8xl text-rose-500 drop-shadow-[0_0_15px_rgba(244,63,94,0.5)]"></i>
                </div>
                <h1 class="text-xl text-rose-300 font-bold mb-2">é€£çµå»ºç«‹ä¸­...</h1>
                <h2 class="text-3xl font-black text-white mb-6 tracking-widest neon-text-pink">æ˜Ÿéš›é‡é›£è€…</h2>
                <div class="bg-gray-900/80 px-6 py-4 rounded-2xl shadow-lg border border-rose-800 mb-8">
                    <div class="text-gray-400 text-xs mb-1">æŒ‡æ®å®˜è­˜åˆ¥</div>
                    <div id="waiting-name" class="text-3xl font-black text-rose-500">...</div>
                </div>
                <div class="flex items-center gap-2 text-rose-300 bg-rose-900/50 px-4 py-2 rounded-full border border-rose-700 animate-pulse">
                    <i class="fa-solid fa-radar animate-spin"></i>
                    <span>ç­‰å¾…è‰¦éšŠæŒ‡ä»¤...</span>
                </div>
            </div>

            <!-- === æŠ½å¡ç•«é¢ (æœ¬åœ°ç«¯) === -->
            <div id="draw-view" class="view-section hidden h-full flex flex-col p-4">
                <h1 class="text-center text-rose-400 font-bold mb-4 mt-8 uppercase tracking-widest">ç‰©è³‡æƒæå®Œæˆ</h1>
                <div id="draw-card-container" class="flex-1 flex flex-col justify-center items-center text-center"></div>
                <button onclick="confirmDraw()" class="w-full py-5 bg-gradient-to-r from-rose-600 to-rose-500 text-white rounded-2xl font-black text-xl shadow-lg mt-8 hover:scale-105 transition-transform flex items-center justify-center gap-2 border border-rose-400">
                    <span>ç¢ºèªæ¥æ”¶</span> <i class="fa-solid fa-box-open"></i>
                </button>
            </div>

            <!-- === æŠ‰æ“‡ç•«é¢ (æ ¸å¿ƒ) === -->
            <div id="action-view" class="view-section hidden h-full flex flex-col">
                <!-- é ‚éƒ¨è³‡è¨Š -->
                <div class="flex justify-between items-center mb-4 px-2">
                    <div class="text-white font-black text-xl flex items-center gap-2">
                        <i class="fa-solid fa-clock text-rose-500"></i> Day <span id="round-num" class="text-2xl text-rose-400">1</span>
                    </div>
                    <div id="my-lives-display"></div>
                </div>

                <!-- è‡ªå·±çš„é£Ÿç‰© (ç½®ä¸­å¤§åœ–) -->
                <div id="my-food-display" class="bg-gray-900/60 p-4 rounded-3xl border border-rose-900 mb-4 shadow-lg relative overflow-hidden">
                    <!-- JS Insert -->
                </div>

                <div id="ghost-alert" class="hidden text-xs text-center text-gray-400 bg-gray-800 px-2 py-1 rounded-lg mb-2 border border-gray-600">ğŸ‘» å¹½éˆæ¨¡å¼ï¼šç„¡å¯¦é«”ç‹€æ…‹</div>

                <!-- è¦å‰‡æç¤ºå¡ -->
                <div class="bg-rose-950/50 border border-rose-800 p-3 rounded-2xl mb-4 text-center">
                    <div class="text-xs text-rose-400 font-bold flex items-center justify-center gap-1">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        <span>ç”Ÿå­˜æ³•å‰‡</span>
                    </div>
                    <div class="text-sm text-gray-200 font-bold mt-1">
                        é™£ç‡Ÿç¸½èƒ½é‡ Ã· äººæ•¸ < 60 <i class="fa-solid fa-arrow-right mx-1 text-rose-500"></i> ğŸ’” æ‰£ä¸€å‘½
                    </div>
                </div>

                <!-- å³æ™‚æˆ°æ³ -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-gray-900/80 p-3 rounded-2xl border border-alien-dark text-center shadow-lg relative overflow-hidden">
                        <div class="absolute inset-0 bg-alien/5 pointer-events-none"></div>
                        <div class="text-xs text-alien-glow font-bold mb-1">å¤–æ˜Ÿäººèƒ½é‡</div>
                        <div id="stat-energy-a" class="text-3xl font-black text-alien">0</div>
                    </div>
                    <div class="bg-gray-900/80 p-3 rounded-2xl border border-earth-dark text-center shadow-lg relative overflow-hidden">
                        <div class="absolute inset-0 bg-earth/5 pointer-events-none"></div>
                        <div class="text-xs text-earth-glow font-bold mb-1">åœ°çƒäººèƒ½é‡</div>
                        <div id="stat-energy-b" class="text-3xl font-black text-earth">0</div>
                    </div>
                </div>

                <!-- æ“ä½œå€ -->
                <div class="space-y-5 flex-1">
                    <div>
                        <label class="text-xs text-gray-400 mb-2 block font-bold px-2 tracking-wider">ğŸ“¦ å‚³è¼¸ç‰©è³‡çµ¦...</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="btn-food-a" onclick="toggleChoice('food', 'A')">å¤–æ˜Ÿäºº</button>
                            <button id="btn-food-b" onclick="toggleChoice('food', 'B')">åœ°çƒäºº</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 mb-2 block font-bold px-2 tracking-wider">ğŸš€ ç§»å‹•èº«é«”è‡³...</label>
                        <div class="grid grid-cols-2 gap-3 h-24">
                            <button id="btn-group-a" onclick="toggleChoice('group', 'A')">
                                <i class="fa-brands fa-reddit-alien text-2xl mb-1"></i> å¤–æ˜Ÿäºº
                            </button>
                            <button id="btn-group-b" onclick="toggleChoice('group', 'B')">
                                <i class="fa-solid fa-earth-americas text-2xl mb-1"></i> åœ°çƒäºº
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="text-center text-xs text-rose-800/50 mt-2 font-mono">WAITING FOR SERVER SYNC...</div>
            </div>

            <!-- === çµæœç•«é¢ === -->
            <div id="result-view" class="view-section hidden h-full flex flex-col">
                <h1 class="text-center text-2xl font-black text-white mb-8 mt-4 uppercase tracking-wider neon-text-pink">ç”Ÿå­˜å ±å‘Š</h1>
                <div id="result-content" class="flex-1 flex flex-col justify-center"></div>
                <div class="mt-auto text-center text-rose-400 text-sm animate-pulse mb-4">
                    ç­‰å¾…ä¸‹ä¸€å›åˆæŒ‡ä»¤...
                </div>
            </div>

            <!-- === çµæŸç•«é¢ === -->
            <div id="end-view" class="view-section hidden h-full flex flex-col justify-center items-center text-center">
                <div class="mb-6 float-anim">
                    <i class="fa-solid fa-flag-checkered text-7xl text-yellow-500 drop-shadow-lg"></i>
                </div>
                <h1 class="text-4xl font-black text-white mb-4 neon-text-pink">ç”Ÿå­˜æˆ°çµæŸ</h1>
                <p class="text-gray-400">å­˜æ´»çš„æŒ‡æ®å®˜ï¼Œæ­å–œå®Œæˆä»»å‹™ï¼</p>
                <div class="mt-12 text-sm text-rose-800">Mission Complete</div>
            </div>

            <!-- === ç®¡ç†å“¡ç•«é¢ === -->
            <div id="admin-view" class="view-section hidden absolute inset-0 bg-gray-950 z-50 flex flex-col p-4 overflow-y-auto">
                <h1 class="text-rose-500 font-bold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-terminal"></i> GM æ§åˆ¶å°
                </h1>
                
                <div id="admin-summary"></div>
                <div id="admin-status" class="text-xs font-mono mb-4 bg-black p-2 rounded text-gray-400 border border-gray-800"></div>
                <div id="admin-controls" class="space-y-3 mb-4"></div>
                <div id="admin-players" class="flex-1 overflow-y-auto bg-gray-900 rounded-xl border border-gray-800 p-2"></div>
            </div>

        </div>
    </div>

</body>
</html>
